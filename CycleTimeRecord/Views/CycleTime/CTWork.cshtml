@using PagedList
@using PagedList.Mvc
@model IPagedList<CycleTimeRecord.Models.CTWorks.CT_DataList>

@{
    ViewBag.Title = "標準工時作業";
}

<head>
    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <style>
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pagination-container {
            flex: 1;
        }

        .date-filter {
            display: flex;
            align-items: center;
        }

            .date-filter input[type="date"] {
                width: 140px;
                margin: 0 5px;
                height: 36px;
            }

            .date-filter label {
                margin: 0 5px;
                white-space: nowrap;
            }

        /********* select2 ***************************************************************************************/
        .select2-container .select2-selection--single {
            box-sizing: border-box;
            cursor: pointer;
            display: block;
            height: 34px !important; /* 匹配 form-control 的高度 */
            padding: 6px 12px !important; /* 匹配 form-control 的內邊距 */
            line-height: 22px !important; /* 調整行高以使文字垂直居中 (34px - 2*6px) */
            font-size: 14px; /* 匹配 form-control 的字體大小 */
            line-height: 1.42857143; /* 匹配 form-control 的行高 */
            color: #555555; /* 匹配 form-control 的文字顏色 */
            background-color: #fff !important; /* 匹配 form-control 的背景顏色 */
            background-image: none; /* 匹配 form-control 的背景圖片 */
            border: 1px solid #ccc !important; /* 匹配 form-control 的邊框 */
            border-radius: 4px !important; /* 匹配 form-control 的圓角 */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #555555 !important; /* 確保選中文字顏色一致 */
            line-height: 22px; /* 調整 line-height 使文字垂直居中 (34px - 2*6px) */
            padding-left: 0; /* 移除 Select2 預設的左內邊距 */
            padding-right: 0; /* 移除 Select2 預設的右內邊距 */
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 32px !important; /* 調整箭頭容器高度 (略小於總高度以適應邊框) */
            position: absolute;
            top: 1px !important;
            right: 1px !important;
            width: 20px;
        }

            .select2-container--default .select2-selection--single .select2-selection__arrow b {
                border-color: #333 transparent transparent transparent !important; /* 調整箭頭顏色 */
                border-style: solid;
                border-width: 0 4px 6px 4px;
                height: 0;
                left: 50%;
                margin-left: -4px;
                margin-top: -3px !important; /* 調整箭頭垂直位置 */
                position: absolute;
                top: 50%;
                width: 0;
            }

        .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
            border-color: transparent transparent #333 transparent !important; /* 調整展開時的箭頭顏色 */
            border-width: 6px 4px 0 4px;
            margin-top: -4px !important; /* 調整展開時箭頭垂直位置 */
        }

            .select2-container .select2-selection--multiple .select2-selection__rendered {
                list-style: none;
                margin: 0;
                padding: 0 5px;
                width: 100%;
            }

                .select2-container .select2-selection--multiple .select2-selection__rendered li {
                    float: left;
                    list-style: none;
                }

                .select2-container .select2-selection--multiple .select2-selection__rendered .select2-selection__choice {
                    background-color: #f0f0f0 !important; /* 接近 form-control 的淺灰色 */
                    border: 1px solid #ccc !important;
                    border-radius: 4px !important;
                    color: #555555 !important;
                    cursor: default;
                    float: left;
                    margin-right: 5px;
                    margin-top: 2px !important; /* 調整與文字的垂直間距 */
                    padding: 0px 5px !important; /* 調整標籤的內邊距 */
                }

                .select2-container .select2-selection--multiple .select2-selection__rendered .select2-selection__choice__remove {
                    color: #888;
                    cursor: pointer;
                    display: inline-block;
                    font-weight: bold;
                    margin-left: 5px;
                }

            .select2-container .select2-selection--multiple .select2-search--inline {
                float: left;
            }

                .select2-container .select2-selection--multiple .select2-search--inline .select2-search__field {
                    border: none;
                    outline: none;
                    box-shadow: none;
                    -webkit-appearance: none;
                    background: transparent;
                    color: inherit;
                    font-size: 14px !important; /* 匹配 form-control 的字體大小 */
                    line-height: 22px !important; /* 調整行高 */
                    height: 22px !important; /* 調整搜尋框的高度 */
                    padding: 0;
                    margin-top: 6px !important; /* 調整搜尋框的垂直位置 */
                }
        /********* select2 ***************************************************************************************/
    </style>
    <script>
        let searchTimeout;

        function loadPartial(page) {
            clearTimeout(searchTimeout); // 清除之前的計時器
            searchTimeout = setTimeout(function () { // 延遲執行，避免過快觸發
                $.ajax({
                    url: '@Url.Action("CTWorkSearch", "CycleTime")',
                    type: 'POST',
                    data: {
                        page: page,
                        engSr: $("#EngSr").val(),
                        Line: $("#Line").val(),
                        TB: $("#T_B").val(),
                        BoardSum: $("#BoardSum").val(),
                        BottleneckHours: $("#BottleneckHours").val(),
                        indate: $("#indate").val(), //日期起
                        indate2: $("#indate2").val(),//日期迄
                        Mark: $("#Mark").val()
                    },
                    beforeSend: function () {
                        console.log("AJAX Request Sent!");
                        $('#partialViewContainer').html('<p>載入中...</p>');
                    },
                    success: function (response) {
                        if (response.success) {
                            console.log("Partial View Data: ", response.partialView);
                            $('#partialViewContainer').html(response.partialView); // 更新部分視圖
                            $('#percentageDisplay').text("中檢可抽百分比:" + response.percentage + "%"); // 更新主視圖的數值
                        } else if (response.error && response.redirect) {
                            window.location.href = response.redirect; // 重新導向登入
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                        alert('資料載入失敗，請稍後再試！');
                    }
                });
            }, 500); // 500 毫秒延遲執行
        }

        $(document).ready(function () {
            $("#btnSearch").click(function () {
                loadPartial(1);
            });
            //日期結束
            $("#indate2").change(function () {
                loadPartial(1);
            });



            $("#btnClear").click(function () {
                $("#Line, #EngSr, #T_B, #BoardSum, #Text1, #Text2, #Text3, #Other, #Mark, #BottleneckHours, #OPCnt, #MEmarkAdd").val("");


                /****** 呂奕潔提出 [ME 確認原因]改下拉 20250430 By Jesse 起 ******************************************/
                $('#MEmark').val(null).trigger('change');
                /****** 呂奕潔提出 [ME 確認原因]改下拉 20250430 By Jesse 迄 ******************************************/

                /****** 呂奕潔提出 [工時原因]改下拉 20250505 By Jesse 起 ******************************************/
                $('#Mark').val(null).trigger('change');
                /****** 呂奕潔提出 [工時原因]改下拉 20250505 By Jesse 迄 ******************************************/

                loadPartial(1);
            });
        });


        ///即時計算瓶頸工時
        $(document).ready(function () {
            $("#Text1,#Text2,#Text3,#Other").change(function () {
                var t1 = $("#Text1").val();
                var t2 = $("#Text2").val();
                var t3 = $("#Text3").val();
                var t4 = $('#Other').val();
                // 找出最大值
                var maxNum = Math.max(t1, t2, t3, t4);
                var result = (maxNum * 1.04).toFixed(2); //2025.02.24 modify 原1.08 → 1.04
                $("#BottleneckHours").val(result);
            });
        });

        /// 根據選擇的 Line，設定對應的 label 名稱
        $(document).ready(function () {
            $("#Line").change(function () {
                var selectedLine = $(this).val();
                switch (selectedLine) {
                    case "L1":
                    case "L3":
                        $("#lab1").text("NXT");
                        $("#lab2").text("XPF1");
                        $("#lab3").text("AIMEX");
                        break;
                    case "L2":
                        $("#lab1").text("FX3");
                        $("#lab2").text("JUKI50");
                        $("#lab3").text("JUKI80");
                        break;
                    case "L4":
                        $("#lab1").text("NXT");
                        $("#lab2").text("XPF1");
                        $("#lab3").text("XPF2");
                        break;
                    default:
                }

            });
        });

        ///即時更新對應之機台工時Text1~Text3
        $(document).ready(function () {
            $("#Line, #EngSr, #T_B").change(function () {
                var selectedLine = $("#Line").val();
                var engSrValue = $("#EngSr").val();
                var selectedLineT_B = $("#T_B").val();

                // 如果 Line 和 EngSr 都有值，發送 Ajax 查詢
                if (selectedLine && engSrValue && selectedLineT_B) {
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("CTWorkAjax", "CycleTime")",
                        data: { line: selectedLine, engSr: engSrValue, TB: selectedLineT_B },
                        success: function (data) {
                            // 更新 Textbox 的值
                            // 確認 data 不是 undefined 並且至少包含一個元素
                            if (data && data.length > 0) {
                                // 更新 Textbox 的值
                                $("#Text1").val(data[0].Text1);
                                $("#Text2").val(data[0].Text2);
                                $("#Text3").val(data[0].Text3);
                                $('#Other').val(data[0].Other);
                                $('#Mark').val(data[0].Mark).trigger('change');
                                $('#MEmarkAdd').val(data[0].MEmarkAdd);

                                // [工時原因] 如果不存在，創建一個新的 Option By 20250505 Jesse
                                var Markval;
                                if (data[0])
                                {
                                    Markval = data[0].Mark;
                                    var $MarkSelect = $('#Mark');
                                    if ($MarkSelect)
                                    {
                                        var MarkExists = $MarkSelect.find('option[value="' + Markval + '"]').length > 0;
                                        if (!MarkExists)
                                        {
                                            var newOptionMark = new Option(Markval, Markval, true, true);
                                            $MarkSelect.append(newOptionMark).trigger('change');
                                        }
                                        else {
                                            $MarkSelect.val(Markval).trigger('change');
                                        }
                                    }
                                }

                                $("#BottleneckHours").val(data[0].BottleneckHours);
                                $("#BoardSum").val(data[0].BoardSum);
                                $("#OPCnt").val(data[0].OP_Cnt);

                                // [ME確認原因] 如果不存在，創建一個新的 Option By 20250505 Jesse
                                var MEmarkval ;
                                if (data[0])
                                {
                                    MEmarkval = data[0].ME_mark;
                                    var $MEmarkSelect = $('#MEmark');

                                    if ($MEmarkSelect)
                                    {
                                        var MEmarkExists = $MEmarkSelect.find('option[value="' + MEmarkval + '"]').length > 0;
                                        if (!MEmarkExists)
                                        {
                                            var newOptionMEmark = new Option(MEmarkval, MEmarkval, true, true);
                                            $MEmarkSelect.append(newOptionMEmark).trigger('change');
                                        }
                                        else
                                        {
                                            $MEmarkSelect.val(MEmarkval).trigger('change');
                                        }
                                    }
                                }

                            } else {
                                // 如果 data 為空，清空相關 Textbox 的值
                                $("#Text1").val("");
                                $("#Text2").val("");
                                $("#Text3").val("");
                                $('#Other').val("");
                                $("#BottleneckHours").val("");
                                $("#BoardSum").val("");
                                $("#Mark").val("").trigger('change');
                                $("#OPCnt").val("");
                                $("#MEmark").val("").trigger('change');
                                $('#MEmarkAdd').val('');
                            }
                        },
                        error: function (error) {
                            console.log("Ajax request failed: " + error);
                        }
                    });
                }
            });
        });

        $(document).ready(function () {
            $('#btnSearch').click(function () {
                $.ajax({
                    url: '@Url.Action("CTWorkSearch", "CycleTime")',
                    type: 'POST',
                    data: {
                        engSr: $("#EngSr").val(),
                        Line: $("#Line").val(),
                        TB: $("#T_B").val(),
                        BoardSum: $("#BoardSum").val(),
                        BottleneckHours: $("#BottleneckHours").val(),
                        //Other: $("#Other").val(),
                        Mark: $("#Mark").val()
                    },
                    cache: false,
                    success: function (data) {
                        // 更新部分視圖
                        $('#partialViewContainer').html(data);
                    },
                });
            });
        });

        ///更新
       $(document).ready(function () {
            $('#btnAllRun').click(function () {
                console.log("btnAllRun clicked"); // 添加這行
                var t1 = isValidFloat($("#Text1").val());
                var t2 = isValidFloat($("#Text2").val());
                var t3 = isValidFloat($("#Text3").val());
                var t4 = isValidFloat($("#Other").val());
                var t5 = isValidFloat($("#BoardSum").val());
                var t6 = isValidFloat($("#OPCnt").val());

                var MEmarkAdd = $('#MEmarkAdd').val();
                var MEmark = $("#MEmark").val();

                var ErrorMsg = '';

                if ($("#EngSr").val().trim() === '' || $("#EngSr").val() === null || typeof $("#EngSr").val() === 'undefined') {
                    ErrorMsg += '機種名稱不可為空\n';
                }
                if ($('#BottleneckHours').val().trim() === '' || $("#BottleneckHours").val() === null || typeof $("#BottleneckHours").val() === 'undefined') {
                    ErrorMsg += '瓶頸工時不可為空\n';
                }
           
                if (ErrorMsg != '') {
                    confirm(ErrorMsg);
                    return;
                }
               
                // [ME確認原因]可能會出現手動輸入null By 20250513 Jesse
                if (MEmark === null || MEmark === 'null' || typeof MEmark === 'undefined') {
                    MEmark = "";
                }
                // 新增[ME確認原因補充]，儲存時合併[ME確認原因]+[ME確認原因補充] 20250505 By Jesse
                // [ME確認原因補充]單獨存 2025027 By Jesse
                if (MEmarkAdd === null || MEmarkAdd === 'null' || typeof MEmarkAdd === 'undefined') {
                    MEmarkAdd = "";
                }

                $.ajax({
                    url: '@Url.Action("CTWorkInHistory", "CycleTime")',
                    type: 'POST',
                    data: {
                        engSr: $("#EngSr").val(),
                        Line: $("#Line").val(),
                        TB: $("#T_B").val(),
                        Text1: t1,
                        Text2: t2,
                        Text3: t3,
                        BoardSum: t5,
                        BottleneckHours: $("#BottleneckHours").val(),
                        Other: t4,
                        Mark: $("#Mark").val(),
                        OPCnt: t6,
                        MEmark: MEmark,
                        MEmarkAdd: MEmarkAdd,
                    },
                    cache: false,
                    success: function (data) {
                        console.log("Ajax request success"); // 添加這行
                        // 更新部分視圖
                        $('#partialViewContainer').html(data);
                    },
                    error: function (xhr, status, error) {
                        console.log("Ajax request failed. Status:", status);
                        console.log("Error:", error);
                        console.log("XHR object:", xhr);

                        // 可以將以下信息添加到 alert 中，以便在瀏覽器中查看
                        alert('Ajax request failed. ' + '\nError: 輸入錯誤或查無資料');
                    },
                });
            });
           function isValidFloat(value) {
               var parsedValue = parseFloat(value);
               return !isNaN(parsedValue) ? parsedValue : 0;
           }
        });
    </script>
</head>

<body>
    <h2>標準工時作業</h2>
    <div class="panel panel-primary">
        <div class="panel-heading">工時管理</div>
        <div class="panel-body">
            <!-- 其他查詢條件區 -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="Lnx">線別</label>
                        <select id="Line" name="Line" class="form-control">
                            <option value="">請選擇...</option>
                            <option value="L1">1線　|　L-1</option>
                            <option value="L2">2線　|　L-2</option>
                            <option value="L3">3線　|　L-3</option>
                            <option value="L4">4線　|　L-4</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- 其他查詢條件 (例如 EngSr, T_B, BoardSum, Text1, Text2, Text3, Other, Mark, 等) -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="EngSr">機種名稱</label>
                        <input type="text" class="form-control" id="EngSr" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="TB">板面</label>
                        <select id="T_B" name="T_B" class="form-control">
                            <option value="">請選擇...</option>
                            <option value="TOP">T　|　TOP</option>
                            <option value="BOT">B　|　BOT</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="BoardSum">板數</label>
                        <input type="text" class="form-control" id="BoardSum" name="BoardSum" required>
                    </div>
                </div>
            </div>
            <!-- 更新區 -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="lab1" id="lab1"></label>
                        <input type="text" class="form-control" id="Text1" name="Text1" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="lab2" id="lab2"></label>
                        <input type="text" class="form-control" id="Text2" name="Text2" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="lab3" id="lab3"></label>
                        <input type="text" class="form-control" id="Text3" name="Text3" required>
                    </div>
                </div>
            </div>
            <!-- 其他更新區 -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="other">其他瓶頸(印刷、SPI、錫爐、手放)</label>
                        <input type="text" class="form-control" id="Other" name="Other" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <!-- [工時原因]更改為下拉選並可以手動輸入 20250505 By Jesse -->
                        <label for="mark">工時原因</label>
                        <select class="form-control" id="Mark" name="Mark" style="width:295px" required>
                            <option value="">請選擇...</option>
                            @foreach (var item in ViewBag.MarkOptions)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="BottleneckHours">瓶頸工時(權重*1.04)</label>
                        <input type="text" class="form-control" id="BottleneckHours" name="BottleneckHours" readonly="readonly" required>
                    </div>
                </div>
            </div>
            <!-- 數值更新區 -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="OPCnt">標準人數</label>
                        <input type="text" class="form-control" id="OPCnt" name="OPCnt" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <!-- [ME確認原因]更改為下拉選並可以手動輸入 20250430 By Jesse -->
                        <label for="MEmark">ME確認原因</label>
                        <select class="form-control" id="MEmark" name="MEmark" required>
                            <option value="">請選擇...</option>
                            @foreach (var item in ViewBag.MEmarkOptions)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <!--新增 [ME確認原因補充] 20250505 By Jesse -->
                <!--新增 資料表[ME確認原因補充] 20250527 By Jesse -->
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="MEmarkAdd">ME確認原因補充</label>
                        <input type="text" class="form-control" id="MEmarkAdd" name="MEmarkAdd">
                    </div>
                </div>
            </div>
            <!-- 查詢與清除 -->
            <div class="row">
                <div class="col-md-4">
                    <input type="button" value="查詢" id="btnSearch" class="btn btn-danger" />
                </div>
                <div class="col-md-4">
                    <input type="button" value="清除查詢" id="btnClear" class="btn btn-default" />
                </div>
                <div class="col-md-4">
                    @if (@ViewBag.RoleId == "A" || @ViewBag.RoleId == "D")
                    {
                        <input type="button" value="瓶頸工時更新" id="btnAllRun" class="btn btn-success" />
                    }
                </div>
            </div>
        </div>
    </div>
</body>

<p></p>

<!-- 主視圖中的部分視圖容器與日期欄位 -->
<div class="header-row">
    <div class="pagination-container">
    </div>
    <div class="date-filter">
        @Html.TextBox("indate", null, new { @type = "date", @id = "indate", @class = "form-control", style = "width: auto;" })
        <label for="indate2" class="mx-2">～</label>
        @Html.TextBox("indate2", null, new { @type = "date", @id = "indate2", @class = "form-control", style = "width: auto;" })
    </div>
    <!-- 顯示 ViewBag 資料的數字 -->
    <span id="percentageDisplay" style="color: red; font-weight: bold;">
        中檢可抽百分比:
        @ViewBag.Percentage%
    </span>

</div>

<div id="partialViewContainer">
    @Html.Partial("_CTWorkPartial", Model)
</div>
@section scripts {
    <link href="~/Content/select2-4.0.8.select2.min.css" rel="stylesheet" />
    <script src="~/Scripts/select2-4.0.8.select2.min.js"></script>
    <script>
        $(function () {
            // select2 初始化
            $('#MEmark').select2({
                tags: true,
                placeholder: '請選擇或輸入...',
                allowClear: true
            });
            $('#Mark').select2({
                tags: true,
                placeholder: '請選擇或輸入...',
                allowClear: true
            });
        });
    </script>
}